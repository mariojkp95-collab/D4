<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Drakoria ‚Äî MAGNET-1</title>
<style>
/* --- STILI (invariati) --- */
:root{
  --bg:#0b1224; --panel:#0f172a; --stroke:#1f2a44; --text:#e5e7eb; --muted:#9ca3af;
  --tileA:#0e2a1e; --tileB:#123022; --block:#15223b;
  --player:#3b82f6; --enemy:#ef4444; --coin:#facc15; --shadow:#0006; --hpBack:#1f2937;
  --accent:#7c3aed; --rare:#60a5fa; --epic:#a78bfa; --legend:#f59e0b;
}
/* ‚Ä¶ (tutto lo stile rimane come nel file che funziona gi√†) ‚Ä¶ */
</style>
</head>
<body>
<header>
  <div><strong>Drakoria</strong> <span class="muted">core</span></div>
  <div>
    <button id="btnQuest">Quest</button>
    <button id="btnMini">Mini-mappa</button>
    <button id="btnInventory">Inventario</button>
    <button id="btnSave">Save</button>
    <button id="btnLoad">Load</button>
    <button id="btnReset">Reset</button>
  </div>
</header>

<main>
  <canvas id="game" width="960" height="576" aria-label="Gioco"></canvas>
  <p class="help">
    Tap per muoverti ‚Ä¢ tap su un <b>nemico</b> per selezionarlo ‚Ä¢ <b>doppio tap</b> per <b>auto-inseguire</b> ‚Ä¢
    <b>üó°Ô∏è</b> / SPAZIO attacca ‚Ä¢ Entra su un <b>sacco</b> per loot.
  </p>
  <div id="status"></div>
</main>

<!-- HUD / bottoni / finestre: invariati -->
<button id="btnAttack" class="fab">üó°Ô∏è</button>
<canvas id="atkCdCanvas" width="56" height="56"></canvas>
<button id="btnUsePotion" class="fab">üçµ</button>
<button id="btnLoot" class="fab" style="display:none">üëú</button>

<div id="miniWrap" class="hidden"><canvas id="mini" width="80" height="48"></canvas></div>
<div class="hotbar" id="hotbar">
  <div class="slot" id="slot1"><span class="lbl">1</span>üçµ<span class="cnt" id="cntPot">0</span></div>
  <div class="slot"><span class="lbl">2</span>‚Äî</div>
  <div class="slot"><span class="lbl">3</span>‚Äî</div>
  <div class="slot"><span class="lbl">4</span>‚Äî</div>
  <div class="slot"><span class="lbl">5</span>‚Äî</div>
</div>

<!-- Quest / Loot / Inventario UI: invariati -->
<aside id="questPanel" class="quest hidden"><div class="q-header"><span>Quest</span><button id="btnQuestClose" class="q-close">√ó</button></div><div id="questBody" class="q-body"></div></aside>
<section id="lootWin" class="loot hidden"><div class="loot-h"><span>Bottino</span><button id="lootClose" class="loot-x">√ó</button></div><div id="lootBody" class="loot-b"></div><div class="loot-f"><button id="lootTakeAll" class="btn">Prendi tutto</button></div></section>
<section id="invWin" class="inv hidden"><div class="inv-h"><span>Inventario</span><button id="invClose" class="inv-x">√ó</button></div><div class="inv-body"><div class="inv-eq">‚Ä¶</div><div class="inv-grid" id="invGrid"></div></div></section>

<div id="errBox" class="err" style="display:none"></div>

<script>
/* ===== Drakoria ‚Äî BUILD MAGNET-1 ===== */
(function(){
  var BUILD='MAGNET-1';
  /* ‚Ä¶ tutto il codice rimane uguale alla versione CRIT-1-FULL che funziona ‚Ä¶ */

  // === PATCH: Pickup magnet (coins/potions entro 1 tile) ===
  function isAdjacent(ax,ay,bx,by){
    return Math.abs(ax-bx)<=1 && Math.abs(ay-by)<=1;
  }

  // Dentro la loop step() sostituire il vecchio blocco pickup:
  function step(){
    try{
      /* ‚Ä¶ logica esistente ‚Ä¶ */

      // --- PICKUP magnet ---
      for(var c=coins.length-1;c>=0;c--){
        if(isAdjacent(coins[c].x,coins[c].y,player.x,player.y)){
          coins.splice(c,1);
          player.coins++;
          questAdd('coin',1);
          gainXP(2);
        }
      }
      for(var p=potions.length-1;p>=0;p--){
        if(isAdjacent(potions[p].x,potions[p].y,player.x,player.y)){
          potions.splice(p,1);
          player.pots++;
          updateHotbarCounts();
        }
      }

      // --- LOOT smart come prima ---
      var onBag = !!getBagAt(player.x, player.y);
      if(!onBag) btnLoot.style.display='none';
      openLootIfAny();

      /* ‚Ä¶ resto invariato ‚Ä¶ */
    }catch(e){ panic('loop',e); }
  }

  /* ‚Ä¶ resto invariato ‚Ä¶ */
})();
</script>
</body>
</html>
