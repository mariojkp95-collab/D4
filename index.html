<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Drakoria ‚Äî D3-HUD1</title>
<style>
:root{
  --bg:#0b1224; --panel:#0f172a; --stroke:#1f2a44; --text:#e5e7eb; --muted:#9ca3af;
  --tileA:#0e2a1e; --tileB:#123022; --block:#15223b;
  --player:#3b82f6; --enemy:#ef4444; --coin:#facc15; --shadow:#0006; --hp:#10b981; --hpBack:#1f2937;
  --accent:#7c3aed;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto}
header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--stroke)}
header .muted{color:var(--muted);margin-left:8px}
header button{background:#26325a;color:#fff;border:1px solid #31406e;border-radius:8px;padding:6px 10px;cursor:pointer}
header button:hover{filter:brightness(1.05)}
main{max-width:1000px;margin:14px auto;padding:12px;background:var(--panel);border:1px solid var(--stroke);border-radius:12px}
#game{display:block;width:100%;height:auto;border-radius:10px;border:1px solid var(--stroke);background:#0a1630;image-rendering:pixelated;touch-action:manipulation}
.help{margin:.6rem 0 0;color:#a1a1aa}
.help .coin{color:var(--coin);font-weight:700}
.help .potion{color:#a78bfa;font-weight:700}
#status{margin-top:8px;color:var(--muted)}

/* Floating buttons */
.fab{
  position: fixed; bottom: 14px; width: 56px; height: 56px; border-radius: 50%;
  border: 1px solid #31406e; background: var(--accent); color:#fff; font-size:24px;
  line-height:56px; text-align:center; cursor:pointer; box-shadow:0 8px 24px rgba(0,0,0,.35); z-index:20;
}
.fab:active{ transform: scale(0.98); }
@media (hover:hover){ .fab:hover{ filter: brightness(1.05); } }

#btnUsePotion{ right: 14px; }   /* üçµ */
#btnAttack{ right: 82px; }      /* üó°Ô∏è */

/* Cooldown ring canvas over the attack button */
#atkCdCanvas{
  position: fixed; right: 82px; bottom: 14px; width:56px; height:56px; z-index:21; pointer-events:none;
}

/* Quest panel */
.quest{
  position: fixed; top: 16px; right: 16px; width: 280px;
  background:#0f172a; border:1px solid #1f2a44; border-radius:10px;
  box-shadow:0 12px 28px rgba(0,0,0,.35); z-index:30
}
.hidden{display:none}
.q-header{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid #1f2a44;font-weight:600}
.q-close{width:28px;height:28px;border-radius:6px;border:1px solid #31406e;background:#26325a;color:#fff;font-size:16px;cursor:pointer}
.q-body{padding:10px}
.q-title{font-weight:700;margin-bottom:6px}
.q-desc{color:#c7cad1;margin-bottom:8px}
.q-row{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
.progress{width:100%;height:10px;background:#0b1224;border:1px solid #1f2a44;border-radius:6px;overflow:hidden}
.progress>div{height:100%;background:var(--accent);width:0%}
.q-reward{color:#d1fae5;margin-top:6px;font-size:13px}
.q-claim{width:100%;margin-top:10px;padding:8px 10px;border:1px solid #31406e;background:#2563eb;color:#fff;border-radius:8px;cursor:pointer}
.q-claim:disabled{background:#1f2a44;color:#9aa0ad;cursor:not-allowed}
</style>
</head>
<body>
<header>
  <div class="left"><strong>Drakoria</strong> <span class="muted">core</span></div>
  <div class="right">
    <button id="btnQuest">Quest</button>
    <button id="btnSave">Save</button>
    <button id="btnLoad">Load</button>
    <button id="btnReset">Reset</button>
  </div>
</header>

<main>
  <canvas id="game" width="960" height="576" aria-label="Gioco"></canvas>
  <p class="help">
    Clicca per muoverti ‚Ä¢ <b>üó°Ô∏è</b> o <b>SPAZIO</b> per attaccare ‚Ä¢ Clic sul nemico adiacente = attacco ‚Ä¢
    Raccogli <span class="coin">‚óè</span> e <span class="potion">üçµ</span> ‚Ä¢ Doppio tap = usa pozione
  </p>
  <div id="status"></div>
</main>

<!-- Floating buttons -->
<button id="btnAttack" class="fab" aria-label="Attacca">üó°Ô∏è</button>
<canvas id="atkCdCanvas" width="56" height="56" aria-hidden="true"></canvas>
<button id="btnUsePotion" class="fab" aria-label="Usa pozione">üçµ</button>

<!-- Quest -->
<aside id="questPanel" class="quest hidden" aria-live="polite">
  <div class="q-header">
    <span>Quest</span>
    <button id="btnQuestClose" class="q-close" aria-label="Chiudi">√ó</button>
  </div>
  <div id="questBody" class="q-body"></div>
</aside>

<script>
/* ===== Drakoria ‚Äî BUILD D3-HUD1 ===== */
(function(){
  const BUILD='D3-HUD1';
  const SAVE_KEY='barebones_save_v3', QUEST_KEY='barebones_quests_v1';

  // --- DOM
  const cv=document.getElementById('game'), ctx=cv.getContext('2d');
  const statusEl=document.getElementById('status');
  const btnReset=document.getElementById('btnReset'), btnSave=document.getElementById('btnSave'), btnLoad=document.getElementById('btnLoad');
  const btnUsePotion=document.getElementById('btnUsePotion'), btnAttack=document.getElementById('btnAttack');
  const atkCdCanvas=document.getElementById('atkCdCanvas'), atkCdCtx=atkCdCanvas.getContext('2d');
  const questPanel=document.getElementById('questPanel'), questBody=document.getElementById('questBody');
  const btnQuest=document.getElementById('btnQuest'), btnQuestClose=document.getElementById('btnQuestClose');

  // --- MAPPA
  const COLS=15, ROWS=9, TILE=64;
  const map=Array.from({length:ROWS},()=>Array(COLS).fill(0));
  function genBlocks(){
    for(let i=0;i<22;i++){
      const x=(Math.random()*COLS|0), y=(Math.random()*ROWS|0);
      if((x===1&&y===1)||(x===COLS-2&&y===ROWS-2)) continue;
      map[y][x]=1;
    }
  } genBlocks();

  // --- PLAYER
  const player={x:1,y:1,hp:100,maxHp:100,coins:0,pots:0,atkMin:6,atkMax:12,lastAtk:0,atkCd:400,lvl:1,exp:0};

  // --- ENEMIES / OBJECTS
  const enemies=[];
  function spawnMelee(x,y){return{type:'melee',x,y,hp:60,maxHp:60,tick:0,mode:'patrol',lastHit:0,hitCd:800,atkMin:5,atkMax:9,moveTick:0,chaseEvery:2,patrolEvery:8}}
  function spawnRanged(x,y){return{type:'ranged',x,y,hp:40,maxHp:40,tick:0,mode:'patrol',atkCd:1200,lastShot:0,rangeMin:3,rangeMax:8,kiteEvery:2,moveTick:0,patrolEvery:10,pokeCd:700,lastPoke:0}}
  const coins=[], potions=[], projectiles=[];
  function randEmpty(){
    for(let k=0;k<800;k++){
      const x=(Math.random()*COLS|0), y=(Math.random()*ROWS|0);
      const occ=(x===player.x&&y===player.y)||enemies.some(e=>e.x===x&&e.y===y)||coins.some(c=>c.x===x&&c.y===y)||potions.some(p=>p.x===x&&p.y===y);
      if(map[y][x]===0 && !occ) return {x,y};
    } return {x:2,y:2};
  }
  for(let i=0;i<6;i++) coins.push(randEmpty());
  for(let i=0;i<2;i++) potions.push(randEmpty());
  enemies.push(spawnMelee(COLS-2, ROWS-2)); { const s=randEmpty(); enemies.push(spawnRanged(s.x,s.y)); }

  // --- UTILS
  const inside=(x,y)=>x>=0&&y>=0&&x<COLS&&y<ROWS, walkable=(x,y)=>inside(x,y)&&map[y][x]===0;
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v)), manhattan=(a,b)=>Math.abs(a.x-b.x)+Math.abs(a.y-b.y), chebyshev=(a,b)=>Math.max(Math.abs(a.x-b.x),Math.abs(a.y-b.y));
  const rndInt=(a,b)=>a+(Math.random()*(b-a+1)|0), getVar=n=>getComputedStyle(document.documentElement).getPropertyValue(n).trim();

  // --- XP/LVL
  const MAX_LVL=99, XP_COIN=2, XP_KILL_MELEE=20, XP_KILL_RANGED=25;
  const xpNeeded=l=>Math.floor(50*Math.pow(l,1.5));
  function gainXP(n){ if(player.lvl>=MAX_LVL) return; player.exp+=n; while(player.lvl<MAX_LVL && player.exp>=xpNeeded(player.lvl)){ player.exp-=xpNeeded(player.lvl); levelUp(); } }
  function levelUp(){ player.lvl=Math.min(MAX_LVL,player.lvl+1); player.maxHp+=10; player.hp=player.maxHp; player.atkMin++; player.atkMax++; player.atkCd=Math.max(200,player.atkCd-20); flashScreen('#22c55e'); }

  // --- QUEST
  const quests=[{id:'q1',title:'Raccogli 10 monete',desc:'Trova e raccogli 10 monete.',type:'collect',target:'coins',needed:10,progress:0,status:'active',reward:{xp:50,pots:1}},
                {id:'q2',title:'Sconfiggi 3 nemici',desc:'Elimina qualsiasi nemico.',type:'kill',target:'any',needed:3,progress:0,status:'locked',reward:{xp:80,coins:3}}];
  let currentQuest=0;
  function renderQuest(){
    const q=quests[currentQuest]; if(!q){ questBody.innerHTML='<div class="q-title">Nessuna quest</div>'; return; }
    const ratio=q.needed?Math.floor(100*(q.progress/q.needed)):100, rw=q.reward||{}, dis=q.status!=='completed';
    questBody.innerHTML=`
      <div class="q-title">${q.title}</div>
      <div class="q-desc">${q.desc}</div>
      <div class="q-row"><div class="progress"><div style="width:${ratio}%"></div></div><div style="margin-left:8px">${q.progress}/${q.needed}</div></div>
      <div class="q-reward">Ricompensa: ${rw.xp?`+${rw.xp} XP `:''}${rw.coins?`¬∑ +${rw.coins} monete `:''}${rw.pots?`¬∑ +${rw.pots} pozione/i`:''}</div>
      <button id="btnClaim" class="q-claim" ${dis?'disabled':''}>Riscatta</button>`;
    const btn=document.getElementById('btnClaim'); if(btn) btn.onclick=claimQuest;
  }
  function questAdd(k,amt){ const q=quests[currentQuest]; if(!q||q.status!=='active') return;
    if(q.type==='collect'&&k==='coin') q.progress=Math.min(q.needed,(q.progress+(amt||1)));
    if(q.type==='kill'&&k.startsWith('kill_')) q.progress=Math.min(q.needed,(q.progress+(amt||1)));
    if(q.progress>=q.needed){ q.status='completed'; toast('Quest completata! Riscatta.'); } renderQuest();
  }
  function claimQuest(){ const q=quests[currentQuest]; if(!q||q.status!=='completed') return;
    const rw=q.reward||{}; if(rw.xp) gainXP(rw.xp); if(rw.coins) player.coins+=rw.coins; if(rw.pots) player.pots+=rw.pots;
    q.status='claimed'; if(currentQuest+1<quests.length){ currentQuest++; if(quests[currentQuest].status==='locked') quests[currentQuest].status='active'; toast('Nuova quest disponibile!'); } else toast('Tutte le quest completate.');
    renderQuest();
  }
  btnQuest.onclick=()=>questPanel.classList.toggle('hidden');
  btnQuestClose.onclick=()=>questPanel.classList.add('hidden');

  // --- PATHFIND
  function bfs(sx,sy,tx,ty){
    if(!walkable(tx,ty)) return null;
    const q=[{x:sx,y:sy}], prev=new Map(), seen=new Set([sx+','+sy]), dirs=[[1,0],[-1,0],[0,1],[0,-1]];
    while(q.length){
      const c=q.shift();
      if(c.x===tx&&c.y===ty){ const path=[]; let k=tx+','+ty; while(prev.has(k)){ const p=prev.get(k), s=k.split(','); path.push({x:+s[0],y:+s[1]}); k=p.x+','+p.y; } return path.reverse(); }
      for(let i=0;i<4;i++){ const nx=c.x+dirs[i][0], ny=c.y+dirs[i][1], kk=nx+','+ny; if(!walkable(nx,ny)||seen.has(kk)) continue; seen.add(kk); prev.set(kk,c); q.push({x:nx,y:ny}); }
    }
    return null;
  }

  // --- INPUT
  let pathQueue=[], lastTapTs=0;
  function canvasToTile(ev){ const r=cv.getBoundingClientRect(); const cx=(ev.clientX??ev.touches?.[0]?.clientX), cy=(ev.clientY??ev.touches?.[0]?.clientY);
    const sx=(cx-r.left)*(cv.width/r.width), sy=(cy-r.top)*(cv.height/r.height);
    return {sx,sy,tx:clamp((sx/TILE)|0,0,COLS-1), ty:clamp((sy/TILE)|0,0,ROWS-1)};
  }
  function enemyRect(e){ const x=e.x*TILE+TILE/2-16, y=e.y*TILE+TILE/2-22; return {x,y,w:32,h:36}; }
  function inRect(px,py,r){ return px>=r.x&&px<=r.x+r.w&&py>=r.y&&py<=r.y+r.h; }

  cv.addEventListener('click',ev=>{
    const m=canvasToTile(ev), now=performance.now(), cdReady=(now-player.lastAtk)>=player.atkCd;
    const adj=enemies.find(e=>chebyshev(player,e)===1 && inRect(m.sx,m.sy,enemyRect(e)));
    if(adj && cdReady){ attackEnemy(adj); return; }
    if(cdReady){ const onTile=enemies.find(e=>chebyshev(player,e)===1 && e.x===m.tx && e.y===m.ty); if(onTile){ attackEnemy(onTile); return; } }
    const p=bfs(player.x,player.y,m.tx,m.ty); if(p&&p.length) pathQueue=p;
  });
  cv.addEventListener('pointerdown',()=>{
    const now=performance.now();
    if(now-lastTapTs<=300){ usePotion(); lastTapTs=0; } else lastTapTs=now;
  });

  // Bottone attacco = come SPAZIO (attacca l‚Äôadiacente)
  function tryAttackAdjacent(){
    const now=performance.now(); const cdReady=(now-player.lastAtk)>=player.atkCd;
    if(!cdReady) return false;
    const adj=enemies.find(en=>chebyshev(player,en)===1);
    if(adj){ attackEnemy
