<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Drakoria ‚Äî split core</title>
<style>
:root{
  --bg:#0b1224; --panel:#0f172a; --stroke:#1f2a44; --text:#e5e7eb; --muted:#9ca3af;
  --accent:#7c3aed;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto}
header{display:flex;align-items:center;justify-content:space-between;background:var(--panel);border-bottom:1px solid var(--stroke);padding:8px 12px}
header .left{display:flex;gap:8px;align-items:center}
.btn{background:#26325a;color:#fff;border:1px solid #31406e;border-radius:8px;padding:6px 10px;cursor:pointer}
.btn:disabled{opacity:.6}
main{max-width:1000px;margin:14px auto;padding:12px;background:var(--panel);border:1px solid var(--stroke);border-radius:12px}
#game{display:block;width:100%;max-width:100%;background:#0a1630;border:1px solid #1c2746;border-radius:10px;image-rendering:pixelated;touch-action:manipulation}
#status{margin-top:8px;color:#cbd5e1;min-height:20px}

/* HUD: hotbar semplice (5 slot) */
.hotbar{margin-top:10px;display:grid;grid-template-columns:repeat(5,56px);gap:8px;justify-content:start}
.slot{position:relative;width:56px;height:56px;border:1px solid #31406e;border-radius:10px;display:grid;place-items:center;background:#101a35}
.slot .lbl{position:absolute;top:3px;left:6px;font-size:12px;color:#9ca3af}
.cap{font-size:20px}
.cnt{position:absolute;bottom:4px;right:6px;font-size:12px;color:#9ca3af}

/* Finestre */
.win{position:fixed;top:64px;right:16px;width:320px;max-width:90vw;background:#0f172a;border:1px solid #1f2a44;border-radius:12px;box-shadow:0 18px 44px rgba(0,0,0,.45);z-index:20}
.win.hidden{display:none}
.win .wh{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid #1f2a44}
.win .wb{padding:10px}
#invGrid,#abilGrid{display:grid;grid-template-columns:1fr;gap:8px}
.invItem,.abilItem{border:1px solid #223054;border-radius:10px;padding:8px;background:#0b162e}
.invItem .row,.abilItem .row{margin-top:8px;display:flex;gap:8px;justify-content:flex-end}

/* PATCH-01 overlay cooldown */
.slot .cd{ position:absolute; inset:0; border-radius:10px;
  background: conic-gradient(#0000 0deg, #0008 0deg); pointer-events:none }
.slot.cooldown{ filter: grayscale(.15); opacity:.9 }

/* FAB */
.fab{position:fixed;right:14px;bottom:14px;width:56px;height:56px;border-radius:50%;border:1px solid #31406e;background:var(--accent);color:#fff;font-size:24px;display:grid;place-items:center;cursor:pointer;z-index:30}
</style>
</head>
<body>

<header>
  <div class="left">
    <button class="btn" id="btnInventory">Inventario</button>
    <button class="btn" id="btnAbilities">Abilit√†</button>
    <button class="btn" id="btnHeal">+10 HP</button>
  </div>
  <div>HP: <span id="hpTxt">0/0</span> ¬∑ EXP: <span id="expTxt">0%</span> ¬∑ Lv <span id="lvTxt">1</span></div>
</header>

<main>
  <canvas id="game" width="800" height="450"></canvas>
  <div class="hotbar">
    <div class="slot" id="slot1"><span class="lbl">1</span><span class="cap" id="slotCap1">üçµ</span><span class="cnt" id="cntPot">0</span><span class="cd" id="cd1"></span></div>
    <div class="slot" id="slot2"><span class="lbl">2</span><span class="cap" id="slotCap2">‚Äî</span><span class="cd" id="cd2"></span></div>
    <div class="slot" id="slot3"><span class="lbl">3</span><span class="cap" id="slotCap3">‚Äî</span><span class="cd" id="cd3"></span></div>
    <div class="slot" id="slot4"><span class="lbl">4</span><span class="cap" id="slotCap4">‚Äî</span><span class="cd" id="cd4"></span></div>
    <div class="slot" id="slot5"><span class="lbl">5</span><span class="cap" id="slotCap5">‚Äî</span><span class="cd" id="cd5"></span></div>
  </div>
  <div id="status"></div>
</main>

<!-- Finestre -->
<section class="win hidden" id="invWin">
  <div class="wh">Inventario <button class="btn" id="invClose">Chiudi</button></div>
  <div class="wb">
    <div id="invGrid"></div>
  </div>
</section>

<section class="win hidden" id="abilWin">
  <div class="wh">Abilit√† <button class="btn" id="abilClose">Chiudi</button></div>
  <div class="wb">
    <div id="abilGrid"></div>
  </div>
</section>

<!-- CORE -->
<script src="game.js?bust=split2" defer></script>

<!-- PATCH-01: cooldown grafico pozione (slot1) -->
<script>
(function(){
  const CD_MS = 5000;
  function ensureOverlay(){
    for(let i=1;i<=5;i++){
      const slot = document.getElementById('slot'+i);
      if(!slot) continue;
      if(!slot.querySelector('.cd')){
        const span=document.createElement('span'); span.className='cd'; span.id='cd'+i;
        slot.appendChild(span);
      }
    }
  }
  let cdEnd = 0;
  function startCd(){
    cdEnd = performance.now() + CD_MS;
    document.getElementById('slot1')?.classList.add('cooldown');
    raf();
  }
  function raf(){
    if(!cdEnd) return;
    const now=performance.now(), left=cdEnd-now, el=document.getElementById('cd1');
    if(!el) return;
    if(left>0){
      const ratio = Math.max(0,Math.min(1,left/CD_MS));
      const deg = Math.floor(360*ratio);
      el.style.background = 'conic-gradient(#0008 '+deg+'deg, #0000 '+deg+'deg)';
      requestAnimationFrame(raf);
    } else {
      document.getElementById('slot1')?.classList.remove('cooldown');
      el.style.background = 'conic-gradient(#0000 0deg, #0008 0deg)';
      cdEnd=0;
    }
  }
  function tryStartAfterUse(){
    const elCnt=document.getElementById('cntPot');
    const before = elCnt ? elCnt.textContent.trim() : '';
    setTimeout(function(){
      const after = elCnt ? elCnt.textContent.trim() : '';
      if(after!==before){ startCd(); }
    }, 40);
  }
  function setup(){
    ensureOverlay();
    document.getElementById('slot1')?.addEventListener('click', tryStartAfterUse, true);
    document.getElementById('btnUsePotion')?.addEventListener('click', tryStartAfterUse, true);
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', setup);
  else setup();
})();
</script>

<!-- ABIL-SIMPLE-PATCH: abilit√† in hotbar + uso dagli slot -->
<script>
(function(){
  const SLOT_IDS=[null,'slot1','slot2','slot3','slot4','slot5'];
  const CAP_IDS =[null,'slotCap1','slotCap2','slotCap3','slotCap4','slotCap5'];
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  function toast(msg){ try{ (window.statusEl||$('#status')).textContent='[ABIL] '+msg; }catch(e){} }
  function ensurePicker(){
    if($('#abilPick')) return;
    const w=document.createElement('section');
    w.id='abilPick';
    w.style.cssText='position:fixed;inset:0;display:none;place-items:center;z-index:2000;background:rgba(0,0,0,.4)';
    w.innerHTML=`<div style="background:#0f172a;border:1px solid #1f2a44;border-radius:12px;padding:12px;width:320px;max-width:90vw;box-shadow:0 18px 44px rgba(0,0,0,.45)">
      <div style="font-weight:700;margin-bottom:8px">Scegli slot</div>
      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px">
        ${[1,2,3,4,5].map(n=>`<button class="pickS" data-s="${n}" style="padding:10px;background:#1e40af;border:1px solid #31406e;color:#fff;border-radius:10px">${n}</button>`).join('')}
      </div>
      <div style="text-align:right;margin-top:10px">
        <button id="abilPickClose" style="padding:6px 10px;background:#26325a;border:1px solid #31406e;color:#fff;border-radius:8px">Annulla</button>
      </div>
    </div>`;
    document.body.appendChild(w);
    w.addEventListener('click', e=>{
      const t=e.target;
      if(t.id==='abilPickClose') w.style.display='none';
      if(t.classList.contains('pickS')){ const s=+t.dataset.s; const cb=window._abilPickCb; window._abilPickCb=null; w.style.display='none'; if(cb) cb(s); }
    }, false);
  }
  function openPicker(cb){ ensurePicker(); window._abilPickCb=cb; document.getElementById('abilPick').style.display='grid'; }
  function setSlotBinding(slot, binding){ // {kind:'ability', icon, abId}
    const el=document.getElementById(SLOT_IDS[slot]); const cap=document.getElementById(CAP_IDS[slot]);
    if(!el||!cap) return;
    el.dataset.kind='ability';
    el.dataset.abId=binding.abId||'';
    el.dataset.icon=binding.icon||'‚ú®';
    cap.textContent=binding.icon||'‚ú®';
  }
  function enhanceAbilitiesOnce(){
    const grid = document.getElementById('abilGrid'); if(!grid) return;
    $$('#abilGrid .abilItem').forEach(card=>{
      if(card._abilDone) return;
      const cap = card.querySelector('.cap');
      let icon='‚ú®'; if(cap){ const m=cap.textContent.trim().match(/^[^\w\s]/); if(m) icon=m[0]; }
      const name=(cap?.textContent||'Abilit√†').trim();
      const abId='ab_'+name.toLowerCase().replace(/\s+/g,'_').replace(/[^\w_]/g,'');

      const row = card.querySelector('.row') || card;
      if(!row.querySelector('.btnToBar')){
        const btn=document.createElement('button');
        btn.className='btn btnToBar';
        btn.textContent='‚Üí Barra';
        btn.style.marginLeft='8px';
        btn.addEventListener('click', ()=> openPicker(s=>{ setSlotBinding(s,{kind:'ability',icon,abId}); toast(`Abilit√† assegnata allo slot ${s}`); }), false);
        row.appendChild(btn);
      }

      // drag (desktop)
      card.draggable=true;
      card.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('text/plain', `ability:${abId}|icon:${encodeURIComponent(icon)}`);
        e.dataTransfer.setDragImage(new Image(),0,0);
      }, false);

      // long-press (mobile)
      (function(){
        let tid=null;
        card.addEventListener('touchstart', ()=>{ tid=setTimeout(()=> openPicker(s=>{ setSlotBinding(s,{kind:'ability',icon,abId}); toast(`Abilit√† assegnata allo slot ${s}`); }), 450); }, {passive:true});
        card.addEventListener('touchend', ()=>{ if(tid){clearTimeout(tid);tid=null;} }, {passive:true});
        card.addEventListener('touchmove', ()=>{ if(tid){clearTimeout(tid);tid=null;} }, {passive:true});
      })();

      card._abilDone = true;
    });
  }
  function triggerAbility(abId){
    if(!abId) return;
    const abilWin = document.getElementById('abilWin');
    const wasHidden = abilWin ? abilWin.classList.contains('hidden') : true;
    if(wasHidden) document.getElementById('btnAbilities')?.click();
    setTimeout(()=>{
      const cards=[...document.querySelectorAll('#abilGrid .abilItem')];
      const card = cards.find(c=>{
        const cap=c.querySelector('.cap')?.textContent||'';
        const id='ab_'+cap.toLowerCase().replace(/\s+/g,'_').replace(/[^\w_]/g,'');
        return id===abId;
      }) || cards[0];
      card?.querySelector('.btnCast')?.click();
      if(wasHidden) document.getElementById('abilClose')?.click();
    }, 50);
  }
  function enableSlotsOnce(){
    const SLOT_IDS=[null,'slot1','slot2','slot3','slot4','slot5'];
    for(let s=1;s<=5;s++){
      const el=document.getElementById(SLOT_IDS[s]); if(!el) continue;
      if(!el._abilTap){
        const handler=(e)=>{ e.preventDefault(); e.stopPropagation(); 
          if((el.dataset.kind||'')==='ability'){ triggerAbility(el.dataset.abId); } 
        };
        el.addEventListener('click', handler, true);
        el.addEventListener('touchend', handler, {passive:false, capture:true});
        el._abilTap=true;
      }
      if(!el._abilDrop){
        el.addEventListener('dragover', e=>{ e.preventDefault(); }, false);
        el.addEventListener('drop', e=>{
          e.preventDefault();
          const data=e.dataTransfer.getData('text/plain')||'';
          if(data.startsWith('ability:')){
            const abId=(data.match(/ability:([^|]+)/)||[])[1];
            const icon=decodeURIComponent((data.match(/icon:([^|]+)/)||[])[1]||'‚ú®');
            if(!abId) return;
            setSlotBinding(s,{kind:'ability',icon,abId});
          }
        }, false);
        el._abilDrop=true;
      }
    }
  }
  function init(){
    enableSlotsOnce();
    document.getElementById('btnAbilities')?.addEventListener('click', ()=> setTimeout(enhanceAbilitiesOnce, 30), false);
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>

<!-- FAB Pozione (core lo crea l'handler) -->
<div class="fab" id="btnUsePotion" title="Usa Pozione">üçµ</div>

</body>
</html>
