<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Drakoria ‚Äî D3-COMPAT-LOOT1</title>
<style>
:root{
  --bg:#0b1224; --panel:#0f172a; --stroke:#1f2a44; --text:#e5e7eb; --muted:#9ca3af;
  --tileA:#0e2a1e; --tileB:#123022; --block:#15223b;
  --player:#3b82f6; --enemy:#ef4444; --coin:#facc15; --shadow:#0006; --hp:#10b981; --hpBack:#1f2937;
  --accent:#7c3aed; --rare:#60a5fa; --epic:#a78bfa; --legend:#f59e0b;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto}
header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--stroke)}
header .muted{color:var(--muted);margin-left:8px}
header button{background:#26325a;color:#fff;border:1px solid #31406e;border-radius:8px;padding:6px 10px;cursor:pointer}
header button:hover{filter:brightness(1.05)}
main{max-width:1000px;margin:14px auto;padding:12px;background:var(--panel);border:1px solid var(--stroke);border-radius:12px;position:relative}
#game{display:block;width:100%;height:auto;border-radius:10px;border:1px solid var(--stroke);background:#0a1630;image-rendering:pixelated;touch-action:manipulation}
.help{margin:.6rem 0 0;color:#a1a1aa}
.help .coin{color:var(--coin);font-weight:700}
.help .potion{color:#a78bfa;font-weight:700}
#status{margin-top:8px;color:var(--muted)}

/* Floating buttons */
.fab{position:fixed;bottom:14px;width:56px;height:56px;border-radius:50%;border:1px solid #31406e;background:var(--accent);color:#fff;font-size:24px;line-height:56px;text-align:center;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,.35);z-index:20}
#btnUsePotion{ right:14px }   /* üçµ */
#btnAttack{ right:82px }      /* üó°Ô∏è */
#atkCdCanvas{ position:fixed; right:82px; bottom:14px; width:56px; height:56px; z-index:21; pointer-events:none }
.err{
  position:fixed;left:50%;top:70px;transform:translateX(-50%);
  background:#7f1d1d;color:#fff;border:1px solid #fecaca;border-radius:8px;
  padding:8px 12px;z-index:50;font-weight:600;max-width:90vw;white-space:pre-wrap
}

/* Quest panel */
.quest{
  position: fixed; top: 16px; right: 16px; width: 280px;
  background:#0f172a; border:1px solid #1f2a44; border-radius:10px;
  box-shadow:0 12px 28px rgba(0,0,0,.35); z-index:30
}
.hidden{display:none}
.q-header{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid #1f2a44;font-weight:600}
.q-close{width:28px;height:28px;border-radius:6px;border:1px solid #31406e;background:#26325a;color:#fff;font-size:16px;cursor:pointer}
.q-body{padding:10px}
.q-title{font-weight:700;margin-bottom:6px}
.q-desc{color:#c7cad1;margin-bottom:8px}
.q-row{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
.progress{width:100%;height:10px;background:#0b1224;border:1px solid #1f2a44;border-radius:6px;overflow:hidden}
.progress>div{height:100%;background:var(--accent);width:0%}
.q-reward{color:#d1fae5;margin-top:6px;font-size:13px}
.q-claim{width:100%;margin-top:10px;padding:8px 10px;border:1px solid #31406e;background:#2563eb;color:#fff;border-radius:8px;cursor:pointer}
.q-claim:disabled{background:#1f2a44;color:#9aa0ad;cursor:not-allowed}

/* Mini-mappa */
#miniWrap{
  position:fixed; top:90px; right:16px; background:#0f172a; border:1px solid #1f2a44;
  border-radius:10px; padding:6px; z-index:25; box-shadow:0 10px 20px rgba(0,0,0,.35)
}
#mini{ display:block; width:160px; height:96px; image-rendering:pixelated }

/* Pulsante mini map */
#btnMini{ margin-left:8px }

/* Hotbar basso ‚Äî alzata per non coprire i FAB */
.hotbar{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:80px;
  display:flex; gap:8px; z-index:22;
  background:rgba(15,23,42,.85); border:1px solid #1f2a44; padding:6px 8px; border-radius:12px; backdrop-filter: blur(4px);
}
.slot{
  width:52px; height:52px; border:1px solid #31406e; border-radius:10px;
  display:grid; place-items:center; background:#111b36; position:relative; cursor:pointer; user-select:none;
}
.slot:active{ transform:scale(0.98) }
.slot .lbl{ position:absolute; left:4px; top:2px; font:700 11px system-ui; color:#93c5fd }
.slot .cnt{ position:absolute; right:4px; bottom:2px; font:700 12px system-ui; color:#e5e7eb; text-shadow:0 1px 2px #000 }

/* Loot window */
.loot{
  position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
  width:320px; max-width:92vw; background:#0f172a; border:1px solid #1f2a44; border-radius:12px;
  box-shadow:0 16px 40px rgba(0,0,0,.45); z-index:40;
}
.loot-h{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #1f2a44;font-weight:700}
.loot-x{width:32px;height:26px;border-radius:6px;border:1px solid #31406e;background:#26325a;color:#fff;cursor:pointer}
.loot-b{padding:10px;display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.itm{
  border:1px solid #2a355c;border-radius:10px;background:#0b1224;display:grid;place-items:center;padding:10px;cursor:pointer;position:relative;min-height:72px
}
.itm .lbl{position:absolute;left:6px;top:6px;font:700 11px system-ui;color:#93c5fd}
.itm .nm{margin-top:6px;font-size:12px;color:#e5e7eb;text-align:center}
.itm .ico{font-size:22px}
.r-com{outline:1px solid #334155}
.r-uncommon{outline:1px solid var(--rare)}
.r-rare{outline:1px solid var(--epic)}
.r-legend{outline:1px solid var(--legend)}
.loot-f{display:flex;gap:8px;justify-content:flex-end;padding:10px;border-top:1px solid #1f2a44}
.btn{border:1px solid #31406e;background:#2563eb;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
.btn:disabled{background:#1f2a44;color:#9aa0ad;cursor:not-allowed}
</style>
</head>
<body>
<header>
  <div><strong>Drakoria</strong> <span class="muted">core</span></div>
  <div>
    <button id="btnQuest">Quest</button>
    <button id="btnMini">Mini-mappa</button>
    <button id="btnSave">Save</button>
    <button id="btnLoad">Load</button>
    <button id="btnReset">Reset</button>
  </div>
</header>

<main>
  <canvas id="game" width="960" height="576" aria-label="Gioco"></canvas>
  <p class="help">
    Clicca per muoverti ‚Ä¢ tap su un <b>nemico</b> per <b>selezionarlo</b> ‚Ä¢ <b>doppio tap</b> sullo stesso nemico per <b>auto-inseguire e attaccare</b> ‚Ä¢
    <b>üó°Ô∏è</b> o <b>SPAZIO</b> attacca se adiacente ‚Ä¢ Raccogli <span class="coin">‚óè</span> e <span class="potion">üçµ</span> ‚Ä¢ Entra su un <b>sacco</b> per aprire il <b>loot</b>
  </p>
  <div id="status"></div>
</main>

<!-- HUD azioni -->
<button id="btnAttack" class="fab" aria-label="Attacca">üó°Ô∏è</button>
<canvas id="atkCdCanvas" width="56" height="56" aria-hidden="true"></canvas>
<button id="btnUsePotion" class="fab" aria-label="Usa pozione">üçµ</button>

<!-- Mini-mappa -->
<div id="miniWrap" class="hidden">
  <canvas id="mini" width="80" height="48" aria-label="Mini mappa"></canvas>
</div>

<!-- Hotbar -->
<div class="hotbar" id="hotbar">
  <div class="slot" id="slot1"><span class="lbl">1</span>üçµ<span class="cnt" id="cntPot">0</span></div>
  <div class="slot"><span class="lbl">2</span>‚Äî</div>
  <div class="slot"><span class="lbl">3</span>‚Äî</div>
  <div class="slot"><span class="lbl">4</span>‚Äî</div>
  <div class="slot"><span class="lbl">5</span>‚Äî</div>
</div>

<!-- Quest -->
<aside id="questPanel" class="quest hidden" aria-live="polite">
  <div class="q-header">
    <span>Quest</span>
    <button id="btnQuestClose" class="q-close" aria-label="Chiudi">√ó</button>
  </div>
  <div id="questBody" class="q-body"></div>
</aside>

<!-- Loot window -->
<section id="lootWin" class="loot hidden" role="dialog" aria-modal="true" aria-label="Bottino">
  <div class="loot-h">
    <span>Bottino</span>
    <button id="lootClose" class="loot-x">√ó</button>
  </div>
  <div id="lootBody" class="loot-b"></div>
  <div class="loot-f">
    <button id="lootTakeAll" class="btn">Prendi tutto</button>
  </div>
</section>

<div id="errBox" class="err" style="display:none"></div>

<script>
/* ===== Drakoria ‚Äî BUILD D3-COMPAT-LOOT1 ===== */
(function(){
  var BUILD='D3-COMPAT-LOOT1';
  var SAVE_KEY='save_xrq1_compat';
  var QUEST_KEY='quests_xrq1_compat';

  var cv=document.getElementById('game'); var ctx=cv.getContext('2d');
  var statusEl=document.getElementById('status');
  var btnAttack=document.getElementById('btnAttack'), btnUsePotion=document.getElementById('btnUsePotion');
  var btnSave=document.getElementById('btnSave'), btnLoad=document.getElementById('btnLoad'), btnReset=document.getElementById('btnReset');
  var btnQuest=document.getElementById('btnQuest'), btnQuestClose=document.getElementById('btnQuestClose');
  var questPanel=document.getElementById('questPanel'), questBody=document.getElementById('questBody');
  var btnMini=document.getElementById('btnMini'), miniWrap=document.getElementById('miniWrap'), mini=document.getElementById('mini'), miniCtx=mini.getContext('2d');
  var slot1=document.getElementById('slot1'), potCntEl=document.getElementById('cntPot');
  var errBox=document.getElementById('errBox');
  var atkCdCanvas=document.getElementById('atkCdCanvas'), atkCdCtx=atkCdCanvas.getContext('2d');

  // Loot UI
  var lootWin=document.getElementById('lootWin'), lootBody=document.getElementById('lootBody');
  var lootClose=document.getElementById('lootClose'), lootTakeAll=document.getElementById('lootTakeAll');

  function panic(where, e){
    errBox.style.display='block';
    errBox.textContent='ERRORE '+where+': '+(e && (e.message||e));
    if(window.console&&console.error) console.error('[PANIC]', where, e);
  }

  try{
    // --- MAPPA
    var COLS=15, ROWS=9, TILE=64;
    var map=[]; for(var y0=0;y0<ROWS;y0++){ var row=[]; for(var x0=0;x0<COLS;x0++) row.push(0); map.push(row); }
    for(var i0=0;i0<16;i0++){ var bx=(Math.random()*COLS|0), by=(Math.random()*ROWS|0); if((bx===1&&by===1)||(bx===COLS-2&&by===ROWS-2)){} else map[by][bx]=1; }

    // --- PLAYER / ENEMY / ITEMS
    var _eid=1; function giveId(e){ e.id=_eid++; return e; }
    var player={x:1,y:1,hp:100,maxHp:100,coins:0,pots:1,atkMin:6,atkMax:12,lastAtk:0,atkCd:450,lvl:1,exp:0};
    var enemies=[
      giveId({type:'melee',x:COLS-2,y:ROWS-2,hp:60,maxHp:60,lastHit:0,hitCd:800,atkMin:5,atkMax:9,mode:'patrol',tick:0,moveEvery:6}),
      giveId({type:'ranged',x:COLS-4,y:2,hp:40,maxHp:40,atkCd:1200,lastShot:0,rangeMin:3,rangeMax:7,kiteEvery:2,moveTick:0,patrolEvery:10,pokeCd:700,lastPoke:0})
    ];
    var coins=[], potions=[], projectiles=[]; // (restano per compat, ma drop principali via loot)
    for(var i1=0;i1<4;i1++) coins.push(randEmpty());
    for(var i2=0;i2<1;i2++) potions.push(randEmpty());

    // --- GROUND LOOT: {x,y,items:[{id,name,icon,rarity,type,qty}]}
    var lootBags=[]; // ogni sacco ha items propri
    var nextItemId=1;

    // --- TARGET LOCK + AUTO-CHASE
    var target=null, autoChase=false, lastEnemyTapTs=0, lastEnemyTapId=-1;

    // --- HUD: floating damage texts
    var dmgTexts=[];

    // --- XP / LEVEL
    var MAX_LVL=99;
    function xpNeeded(l){ return Math.floor(50*Math.pow(l,1.5)); }
    function gainXP(n){
      if(player.lvl>=MAX_LVL) return;
      player.exp+=n;
      while(player.lvl<MAX_LVL && player.exp>=xpNeeded(player.lvl)){
        player.exp-=xpNeeded(player.lvl);
        levelUp();
      }
    }
    function levelUp(){
      player.lvl = Math.min(MAX_LVL, player.lvl+1);
      player.maxHp += 10; player.hp = player.maxHp;
      player.atkMin++; player.atkMax++;
      player.atkCd = Math.max(200, player.atkCd-20);
      flashScreen('#22c55e');
    }

    // --- QUEST (collect 10 coins)
    var quests=[{id:'q1',title:'Raccogli 10 monete',desc:'Trova e raccogli 10 monete.',type:'collect',needed:10,progress:0,status:'active',reward:{xp:50,pots:1}}];
    var currentQuest=0;
    function renderQuest(){
      var q=quests[currentQuest]; if(!q){ questBody.innerHTML='<div class="q-title">Nessuna quest</div>'; return; }
      var ratio=q.needed?Math.floor(100*(q.progress/q.needed)):100, rw=q.reward||{}, dis=(q.status!=='completed');
      questBody.innerHTML=
        '<div class="q-title">'+q.title+'</div>'+
        '<div class="q-desc">'+q.desc+'</div>'+
        '<div class="q-row"><div class="progress"><div style="width:'+ratio+'%"></div></div><div style="margin-left:8px">'+q.progress+'/'+q.needed+'</div></div>'+
        '<div class="q-reward">Ricompensa: '+(rw.xp?('+'+rw.xp+' XP '):'')+(rw.pots?('¬∑ +'+rw.pots+' pozione'): '')+'</div>'+
        '<button id="btnClaim" class="q-claim" '+(dis?'disabled':'')+'>Riscatta</button>';
      var btn=document.getElementById('btnClaim'); if(btn) btn.onclick=claimQuest;
    }
    function questAdd(kind,amt){
      var q=quests[currentQuest]; if(!q||q.status!=='active') return;
      if(q.type==='collect' && kind==='coin'){
        q.progress = Math.min(q.needed, q.progress + (amt||1));
      }
      if(q.progress>=q.needed){ q.status='completed'; toast('Quest completata! Riscatta.'); }
      renderQuest();
    }
    function claimQuest(){
      var q=quests[currentQuest]; if(!q||q.status!=='completed') return;
      var rw=q.reward||{};
      if(rw.xp) gainXP(rw.xp);
      if(rw.pots) player.pots += rw.pots;
      q.status='claimed';
      toast('Ricompensa ottenuta.');
      renderQuest(); updateHotbarCounts();
    }
    document.getElementById('btnQuest').addEventListener('click', function(){ questPanel.classList.toggle('hidden'); }, false);
    btnQuestClose.addEventListener('click', function(){ questPanel.classList.add('hidden'); }, false);
    renderQuest();

    // --- UTILS
    function inside(x,y){ return x>=0&&y>=0&&x<COLS&&y<ROWS; }
    function walkable(x,y){ return inside(x,y)&&map[y][x]===0; }
    function manhattan(a,b){ return Math.abs(a.x-b.x)+Math.abs(a.y-b.y); }
    function chebyshev(a,b){ var dx=Math.abs(a.x-b.x), dy=Math.abs(a.y-b.y); return dx>dy?dx:dy; }
    function rndInt(a,b){ return a+((Math.random()*(b-a+1))|0); }
    function getVar(n){ var cs = window.getComputedStyle(document.documentElement); return cs.getPropertyValue(n).replace(/^\s+|\s+$/g,''); }

    function tileFree(x,y){
      if(map[y][x]!==0) return false;
      var i;
      if(x===player.x && y===player.y) return false;
      for(i=0;i<enemies.length;i++){ if(enemies[i].x===x && enemies[i].y===y) return false; }
      for(i=0;i<coins.length;i++){ if(coins[i].x===x && coins[i].y===y) return false; }
      for(i=0;i<potions.length;i++){ if(potions[i].x===x && potions[i].y===y) return false; }
      for(i=0;i<lootBags.length;i++){ if(lootBags[i].x===x && lootBags[i].y===y) return false; }
      return true;
    }
    function randEmpty(){
      for(var k=0;k<500;k++){
        var x=(Math.random()*COLS|0), y=(Math.random()*ROWS|0);
        if(inside(x,y) && tileFree(x,y)) return {x:x,y:y};
      } return {x:2,y:2};
    }

    // --- PATHFIND (BFS compat)
    function bfs(sx,sy,tx,ty){
      if(!walkable(tx,ty)) return null;
      var q=[{x:sx,y:sy}], head=0;
      var prev={}, seen={}; seen[sx+','+sy]=1;
      var dirs=[[1,0],[-1,0],[0,1],[0,-1]];
      while(head<q.length){
        var c=q[head++]; if(c.x===tx && c.y===ty){
          var path=[], key=tx+','+ty;
          while(prev[key]){
            var s=key.split(','), px=parseInt(s[0],10), py=parseInt(s[1],10);
            path.push({x:px,y:py}); key=prev[key].x+','+prev[key].y;
          } path.reverse(); return path;
        }
        for(var d=0; d<4; d++){
          var nx=c.x+dirs[d][0], ny=c.y+dirs[d][1], kk=nx+','+ny;
          if(!walkable(nx,ny) || seen[kk]) continue;
          seen[kk]=1; prev[kk]={x:c.x,y:c.y}; q.push({x:nx,y:ny});
        }
      }
      return null;
    }
    function bfsToAdjacencySmart(sx,sy,tx,ty,enemyType){
      var opts=[[tx+1,ty],[tx-1,ty],[tx,ty+1],[tx,ty-1]];
      var bestPath=null, bestScore=1e9;
      for(var i=0;i<opts.length;i++){
        var ax=opts[i][0], ay=opts[i][1];
        if(!walkable(ax,ay)) continue;
        var occupied=false, j;
        for(j=0;j<enemies.length;j++){ var e=enemies[j]; if(e.x===ax && e.y===ay){ occupied=true; break; } }
        if(occupied) continue;
        var p=bfs(sx,sy,ax,ay);
        if(!p) continue;
        var score=p.length;
        if(enemyType==='ranged'){ if(ax===tx || ay===ty) score += 2; } // evita allineamento
        if(score<bestScore){ bestScore=score; bestPath=p; }
      }
      return bestPath;
    }

    // --- INPUT
    var pathQueue=[], lastTapTs=0;
    function canvasToTile(ev){
      var r=cv.getBoundingClientRect();
      var hasTouch = ev && ev.touches && ev.touches[0];
      var cx = hasTouch ? ev.touches[0].clientX : ev.clientX;
      var cy = hasTouch ? ev.touches[0].clientY : ev.clientY;
      var sx=(cx-r.left)*(cv.width/r.width), sy=(cy-r.top)*(cv.height/r.height);
      var tx=Math.max(0,Math.min(COLS-1,(sx/TILE)|0));
      var ty=Math.max(0,Math.min(ROWS-1,(sy/TILE)|0));
      return {sx:sx, sy:sy, tx:tx, ty:ty};
    }
    function enemyRect(e){ var x=e.x*TILE+TILE/2-16, y=e.y*TILE+TILE/2-22; return {x:x,y:y,w:32,h:36}; }
    function inRect(px,py,r){ return px>=r.x&&px<=r.x+r.w&&py>=r.y&&py<=r.y+r.h; }

    cv.addEventListener('click',function(ev){
      var m=canvasToTile(ev), now=performance.now(), cd=(now-player.lastAtk)>=player.atkCd;

      // Nemico cliccato?
      var i, clickedEnemy=null;
      for(i=0;i<enemies.length;i++){ var ee=enemies[i]; if(inRect(m.sx,m.sy,enemyRect(ee))){ clickedEnemy=ee; break; } }

      if(clickedEnemy){
        if(lastEnemyTapId===clickedEnemy.id && (now-lastEnemyTapTs)<=350){
          target = clickedEnemy; autoChase = true; pathQueue = [];
        }else{
          target = clickedEnemy; autoChase = false;
        }
        lastEnemyTapId = clickedEnemy.id; lastEnemyTapTs = now;
        draw(); return;
      }

      // Tap a vuoto ‚Üí spegni auto-chase e muovi l√¨
      autoChase = false;
      var p=bfs(player.x,player.y,m.tx,m.ty); if(p && p.length) pathQueue=p;

      if(target && chebyshev(player,target)===1 && cd){ attackEnemy(target); return; }
    }, false);

    cv.addEventListener('pointerdown',function(){
      var now=performance.now();
      if(now-lastTapTs<=300){ usePotion(); lastTapTs=0; } else lastTapTs=now;
    }, false);

    function tryAttackAdjacent(){
      var now=performance.now(); if(now-player.lastAtk<player.atkCd) return false;
      if(target && chebyshev(player,target)===1){ attackEnemy(target); return true; }
      for(var i=0;i<enemies.length;i++){ var en=enemies[i]; if(chebyshev(player,en)===1){ attackEnemy(en); return true; } }
      return false;
    }
    btnAttack.addEventListener('click', tryAttackAdjacent, false);
    btnAttack.addEventListener('touchend', function(e){ e.preventDefault(); tryAttackAdjacent(); }, false);
    window.addEventListener('keydown', function(e){ if(e.code==='Space'||e.key===' ') tryAttackAdjacent(); if(e.key==='e'||e.key==='E') usePotion(); }, false);

    btnUsePotion.addEventListener('click', usePotion, false);
    btnUsePotion.addEventListener('touchend', function(e){ e.preventDefault(); usePotion(); }, false);

    // Hotbar slot1 = pozione
    slot1.addEventListener('click', function(){ usePotion(); }, false);
    slot1.addEventListener('touchend', function(e){ e.preventDefault(); usePotion(); }, false);

    // Mini mappa toggle
    btnMini.addEventListener('click', function(){
      if(miniWrap.classList.contains('hidden')) miniWrap.classList.remove('hidden'); else miniWrap.classList.add('hidden');
      drawMini();
    }, false);

    // --- COMBAT / INTERAZIONI
    function addDmgText(tx,ty,txt,color){ var px=tx*TILE+TILE/2, py=ty*TILE+TILE/2-28; dmgTexts.push({x:px,y:py,txt:txt,color:color,ttl:700,vy:-0.04}); }
    function updateDmgTexts(){ var dt=120; for(var i=dmgTexts.length-1;i>=0;i--){ var d=dmgTexts[i]; d.ttl-=dt; d.y+=d.vy*dt; if(d.ttl<=0) dmgTexts.splice(i,1); } }
    function drawDmgTexts(){ for(var i=0;i<dmgTexts.length;i++){ var d=dmgTexts[i]; var a=Math.max(0,Math.min(1,d.ttl/700)); ctx.save(); ctx.globalAlpha=a; ctx.fillStyle=d.color; ctx.font='bold 16px system-ui'; ctx.textAlign='center'; ctx.fillText(d.txt,d.x,d.y); ctx.restore(); } }

    function attackEnemy(t){
      var now=performance.now(); player.lastAtk=now;
      var dmg=rndInt(player.atkMin,player.atkMax);
      t.hp=Math.max(0,t.hp-dmg); addDmgText(t.x,t.y,'-'+dmg,'#ffd166'); flashCircle(t.x,t.y,'#ff0000',0.25,26);
      if(t.hp===0){
        if(target===t){ target=null; autoChase=false; }
        // genera sacco bottino invece dei vecchi drop random
        spawnLootBag(t.x,t.y, t.type);
        gainXP(t.type==='ranged'?25:20);
        enemies.splice(enemies.indexOf(t),1);
        var s=randEmpty(); var nu = (t.type==='ranged') ? giveId(spawnRangedAt(s.x,s.y)) : giveId(spawnMeleeAt(s.x,s.y));
        enemies.push(nu);
      }
      draw(); drawMini();
    }

    function spawnMeleeAt(x,y){ return {type:'melee',x:x,y:y,hp:60,maxHp:60,lastHit:0,hitCd:800,atkMin:5,atkMax:9,mode:'patrol',tick:0,moveEvery:6}; }
    function spawnRangedAt(x,y){ return {type:'ranged',x:x,y:y,hp:40,maxHp:40,atkCd:1200,lastShot:0,rangeMin:3,rangeMax:7,kiteEvery:2,moveTick:0,patrolEvery:10,pokeCd:700,lastPoke:0}; }

    function usePotion(){ if(player.pots<=0||player.hp>=player.maxHp) return; player.pots--; player.hp=Math.min(player.maxHp,player.hp+35); flashScreen('#8b5cf6'); updateHotbarCounts(); draw(); }
    function gameOver(){ alert('Sei stato sconfitto! Respawn al punto iniziale (niente perdita XP/livello).'); player.hp=player.maxHp; player.x=1; player.y=1; autoChase=false; }

    function hasLoS(ax,ay,bx,by){
      if(ax===bx){ var step=(ay<by)?1:-1; for(var y=ay+step; y!==by; y+=step){ if(map[y][ax]===1) return false; } return true; }
      if(ay===by){ var st=(ax<bx)?1:-1; for(var x=ax+st; x!==bx; x+=st){ if(map[ay][x]===1) return false; } return true; }
      return false;
    }

    // --- LOOT SYSTEM
    function spawnLootBag(x,y, enemyType){
      var items=[];
      // comune: monete 1-3
      var coinQty = rndInt(1,3);
      items.push(makeItem('Monete', 'ü™ô', 'common', 'coin', coinQty));
      // 30% potion
      if(Math.random()<0.30) items.push(makeItem('Pozione', 'üçµ', 'common', 'potion', 1));
      // 20% frammento non comune
      if(Math.random()<0.20) items.push(makeItem('Frammento', 'üß©', 'uncommon', 'shard', 1));
      // 8% gemma rara
      if(Math.random()<0.08) items.push(makeItem('Gemma', 'üî∑', 'rare', 'gem', 1));
      // 2% idolo leggendario
      if(Math.random()<0.02) items.push(makeItem('Idolo', 'üè∫', 'legend', 'idol', 1));

      lootBags.push({x:x,y:y,items:items});
    }
    function makeItem(name, icon, rarity, type, qty){
      return {id: nextItemId++, name:name, icon:icon, rarity:rarity, type:type, qty:qty||1};
    }
    function openLootIfAny(){
      var bag = getBagAt(player.x, player.y);
      if(!bag) return;
      renderLoot(bag);
      lootWin.classList.remove('hidden');
    }
    function getBagAt(x,y){
      for(var i=0;i<lootBags.length;i++){ if(lootBags[i].x===x && lootBags[i].y===y) return lootBags[i]; }
      return null;
    }
    function renderLoot(bag){
      lootBody.innerHTML='';
      var items = bag.items;
      for(var i=0;i<items.length;i++){
        (function(it){
          var d=document.createElement('div'); d.className='itm '+rarityClass(it.rarity);
          d.innerHTML='<span class="lbl">x'+it.qty+'</span><div class="ico">'+it.icon+'</div><div class="nm">'+it.name+'</div>';
          d.addEventListener('click', function(){ takeItem(bag, it.id); }, false);
          lootBody.appendChild(d);
        })(items[i]);
      }
      lootTakeAll.disabled = items.length===0;
      if(items.length===0){ lootBody.innerHTML='<div style="grid-column:1/-1;text-align:center;color:#9aa3b2">Vuoto</div>'; }
    }
    function rarityClass(r){
      if(r==='legend') return 'r-legend';
      if(r==='rare') return 'r-rare';
      if(r==='uncommon') return 'r-uncommon';
      return 'r-com';
    }
    function takeItem(bag, itemId){
      for(var i=0;i<bag.items.length;i++){
        if(bag.items[i].id===itemId){
          applyItem(bag.items[i]);
          bag.items.splice(i,1);
          break;
        }
      }
      if(bag.items.length===0){
        // rimuovi sacco
        lootBags.splice(lootBags.indexOf(bag),1);
        lootWin.classList.add('hidden');
      }else{
        renderLoot(bag);
      }
      draw(); drawMini(); updateHotbarCounts();
    }
    function applyItem(it){
      if(it.type==='coin'){
        player.coins += it.qty; questAdd('coin', it.qty); // quest compat
      }else if(it.type==='potion'){
        player.pots += it.qty;
      }else{
        // shard, gem, idol ‚Üí per ora solo messaggio
        toast('Hai ottenuto: '+it.name+(it.qty>1?(' x'+it.qty):''));
      }
    }
    lootClose.addEventListener('click', function(){ lootWin.classList.add('hidden'); }, false);
    lootTakeAll.addEventListener('click', function(){
      var bag=getBagAt(player.x,player.y); if(!bag) return;
      while(bag.items.length){ applyItem(bag.items.shift()); }
      lootBags.splice(lootBags.indexOf(bag),1);
      lootWin.classList.add('hidden');
      draw(); drawMini(); updateHotbarCounts();
    }, false);

    // --- SAVE/LOAD/RESET
    btnSave.addEventListener('click', function(){
      try{
        localStorage.setItem(SAVE_KEY, JSON.stringify({
          map:map, player:player, enemies:enemies, coins:coins, potions:potions, projectiles:projectiles,
          lootBags:lootBags, nextItemId:nextItemId
        }));
        localStorage.setItem(QUEST_KEY, JSON.stringify({currentQuest:currentQuest,quests:quests}));
        toast('Salvato.');
      }catch(e){ panic('save',e); }
    }, false);

    btnLoad.addEventListener('click', function(){ try{
      var raw=localStorage.getItem(SAVE_KEY); if(!raw) return alert('Nessun salvataggio.');
      var d=JSON.parse(raw), i,y,x;
      if(d && d.map && d.map.length===ROWS){ for(y=0;y<ROWS;y++){ for(x=0;x<COLS;x++){ map[y][x]=d.map[y][x]|0; } } }
      if(d && d.player){ for(var k in d.player){ if(d.player.hasOwnProperty(k)) player[k]=d.player[k]; } }
      enemies.length=0; if(d && d.enemies){ for(i=0;i<d.enemies.length;i++) enemies.push(d.enemies[i]); }
      coins.length=0; if(d && d.coins){ for(i=0;i<d.coins.length;i++) coins.push(d.coins[i]); }
      potions.length=0; if(d && d.potions){ for(i=0;i<d.potions.length;i++) potions.push(d.potions[i]); }
      projectiles.length=0; if(d && d.projectiles){ for(i=0;i<d.projectiles.length;i++) projectiles.push(d.projectiles[i]); }
      lootBags.length=0; if(d && d.lootBags){ for(i=0;i<d.lootBags.length;i++) lootBags.push(d.lootBags[i]); }
      if(d && d.nextItemId) nextItemId=d.nextItemId|0;
      var qd = localStorage.getItem(QUEST_KEY); if(qd){ var qj=JSON.parse(qd); if(qj){ currentQuest=qj.currentQuest||0; if(qj.quests&&qj.quests.length){ quests[0].progress=qj.quests[0].progress||0; quests[0].status=qj.quests[0].status||'active'; } } }
      renderQuest(); updateHotbarCounts(); draw(); drawMini();
      toast('Caricato.');
    }catch(e){ panic('load',e); } }, false);

    btnReset.addEventListener('click', function(){ location.reload(); }, false);

    // --- LOOP
    function step(){
      try{
        // Auto-chase (se attivo)
        if(autoChase && target){
          var stillThere=false; for(var te=0; te<enemies.length; te++){ if(enemies[te]===target){ stillThere=true; break; } }
          if(!stillThere){ autoChase=false; target=null; }
          if(target && chebyshev(player,target)!==1 && pathQueue.length===0){
            var pAdj=bfsToAdjacencySmart(player.x,player.y,target.x,target.y,target.type);
            if(pAdj && pAdj.length) pathQueue=pAdj;
          }
          if(target && chebyshev(player,target)===1){
            var nowA=performance.now(); if(nowA-player.lastAtk>=player.atkCd) attackEnemy(target);
          }
        }

        // Path player
        if(pathQueue.length){
          var next=pathQueue.shift();
          var blocked=false, i;
          if(!walkable(next.x,next.y)) blocked=true;
          for(i=0;i<enemies.length;i++){ if(enemies[i].x===next.x&&enemies[i].y===next.y){ blocked=true; break; } }
          if(!blocked){ player.x=next.x; player.y=next.y; } else pathQueue=[];
        }

        // Enemy AI
        for(var j=0;j<enemies.length;j++){
          var e=enemies[j];
          if(e.type==='melee'){
            e.tick=(e.tick+1)%e.moveEvery;
            if(e.tick===0){
              var dx = player.x>e.x?1:(player.x<e.x?-1:0);
              var dy = player.y>e.y?1:(player.y<e.y?-1:0);
              var opts=[{x:e.x+dx,y:e.y},{x:e.x,y:e.y+dy},{x:e.x,y:e.y}];
              for(var oi=0;oi<opts.length;oi++){
                var mv=opts[oi]; if(walkable(mv.x,mv.y) && !(mv.x===player.x&&mv.y===player.y)){ e.x=mv.x; e.y=mv.y; break; }
              }
            }
            var near = (Math.abs(e.x-player.x)+Math.abs(e.y-player.y))<=1;
            var now=performance.now();
            if(near && (now-e.lastHit)>=e.hitCd){
              e.lastHit=now; var dmg=rndInt(e.atkMin,e.atkMax);
              player.hp=Math.max(0,player.hp-dmg); addDmgText(player.x,player.y,'-'+dmg,'#ff6b6b'); flashCircle(player.x,player.y,'#ff0000',0.25,26);
              if(player.hp===0) gameOver();
            }
          } else { // ranged
            var dist=manhattan(e,player);
            var adj = (Math.max(Math.abs(e.x-player.x),Math.abs(e.y-player.y))===1);
            var now2=performance.now();
            if(adj){
              if(now2-e.lastPoke>=e.pokeCd){
                e.lastPoke=now2; var dmg2=rndInt(4,7);
                player.hp=Math.max(0,player.hp-dmg2); addDmgText(player.x,player.y,'-'+dmg2,'#ff6b6b'); flashCircle(player.x,player.y,'#ff0000',0.25,26);
                if(player.hp===0) gameOver();
              }
            } else {
              var inRange = (dist>=e.rangeMin && dist<=e.rangeMax && hasLoS(e.x,e.y,player.x,player.y));
              if(inRange){
                if(now2-e.lastShot>=e.atkCd){
                  e.lastShot=now2;
                  var dx2=0,dy2=0;
                  if(e.x===player.x) dy2=player.y>e.y?1:-1; else if(e.y===player.y) dx2=player.x>e.x?1:-1;
                  if(dx2||dy2) projectiles.push({x:e.x,y:e.y,dx:dx2,dy:dy2,spdTick:0,dmg:rndInt(6,10)});
                }
                if(dist<e.rangeMin){
                  var backX=e.x + (player.x<e.x?1:(player.x>e.x?-1:0));
                  var backY=e.y + (player.y<e.y?1:(player.y>e.y?-1:0));
                  if(walkable(backX,backY) && !(backX===player.x&&backY===player.y)){ e.x=backX; e.y=backY; }
                }
              } else {
                if(now2%2===0){
                  var stepX = player.x>e.x?1:(player.x<e.x?-1:0);
                  var stepY = player.y>e.y?1:(player.y<e.y?-1:0);
                  var cand = Math.random()<0.5 ? {x:e.x+stepX,y:e.y} : {x:e.x,y:e.y+stepY};
                  if(walkable(cand.x,cand.y) && !(cand.x===player.x&&cand.y===player.y)){ e.x=cand.x; e.y=cand.y; }
                }
              }
            }
          }
        }

        // PROIETTILI
        for(var pi=projectiles.length-1; pi>=0; pi--){
          var pr=projectiles[pi];
          pr.spdTick=(pr.spdTick+1)%2; if(pr.spdTick!==0) continue;
          var nx=pr.x+pr.dx, ny=pr.y+pr.dy;
          if(!inside(nx,ny) || map[ny][nx]===1){ projectiles.splice(pi,1); continue; }
          if(nx===player.x && ny===player.y){
            var dmgp=pr.dmg; player.hp=Math.max(0,player.hp-dmgp); addDmgText(player.x,player.y,'-'+dmgp,'#ff6b6b'); flashCircle(player.x,player.y,'#ff0000',0.25,26);
            projectiles.splice(pi,1); if(player.hp===0) gameOver(); continue;
          }
          pr.x=nx; pr.y=ny;
        }

        // PICKUP legacy (coins/potions sul terreno) ‚Äî compat
        for(var c=coins.length-1;c>=0;c--) if(coins[c].x===player.x && coins[c].y===player.y){ coins.splice(c,1); player.coins++; questAdd('coin',1); gainXP(2); }
        for(var p=potions.length-1;p>=0;p--) if(potions[p].x===player.x && potions[p].y===player.y){ potions.splice(p,1); player.pots++; updateHotbarCounts(); }

        // Apri loot se stai sopra un sacco
        openLootIfAny();

        updateDmgTexts();
        draw();
        drawAtkCooldown();
        if(!miniWrap.classList.contains('hidden')) drawMini();
      }catch(e){ panic('loop',e); }
    }
    setInterval(step,120);
    draw(); drawAtkCooldown(); drawMini(); updateHotbarCounts();

    // --- DRAW
    function draw(){
      ctx.clearRect(0,0,cv.width,cv.height);
      var x,y;
      for(y=0;y<ROWS;y++) for(x=0;x<COLS;x++){
        ctx.fillStyle = (map[y][x]===1)?getVar('--block'):(((x+y)%2===0)?getVar('--tileA'):getVar('--tileB'));
        ctx.fillRect(x*TILE,y*TILE,TILE,TILE);
      }
      // items legacy
      ctx.fillStyle=getVar('--coin');
      for(var i=0;i<coins.length;i++){ var c=coins[i]; var cx=c.x*TILE+TILE/2, cy=c.y*TILE+TILE/2; ctx.beginPath(); ctx.arc(cx,cy,10,0,Math.PI*2); ctx.fill(); }
      for(var k=0;k<potions.length;k++){ var po=potions[k]; var px=po.x*TILE, py=po.y*TILE;
        ctx.fillStyle='#8b5cf6'; ctx.fillRect(px+TILE/2-8,py+TILE/2-14,16,20);
        ctx.fillStyle='#a78bfa'; ctx.fillRect(px+TILE/2-5,py+TILE/2-20,10,6);
        ctx.fillStyle='#6d28d9'; ctx.fillRect(px+TILE/2-6,py+TILE/2-24,12,4);
        ctx.fillStyle='#0006'; ctx.beginPath(); ctx.ellipse(px+TILE/2,py+TILE-12,12,4,0,0,Math.PI*2); ctx.fill();
      }
      // loot bags
      for(var lb=0; lb<lootBags.length; lb++){
        var b=lootBags[lb], bx=b.x*TILE, by=b.y*TILE;
        // ombra
        ctx.fillStyle=getVar('--shadow'); ctx.beginPath(); ctx.ellipse(bx+TILE/2,by+TILE-10,16,6,0,0,Math.PI*2); ctx.fill();
        // sacco
        ctx.fillStyle='#b45309'; ctx.beginPath(); ctx.moveTo(bx+TILE/2-12,by+TILE/2+6);
        ctx.lineTo(bx+TILE/2+12,by+TILE/2+6); ctx.lineTo(bx+TILE/2+8,by+TILE/2-8);
        ctx.lineTo(bx+TILE/2-8,by+TILE/2-8); ctx.closePath(); ctx.fill();
        // laccio
        ctx.fillStyle='#78350f'; ctx.fillRect(bx+TILE/2-8,by+TILE/2-8,16,3);
        // iconina sopra
        ctx.fillStyle='#facc15'; ctx.font='bold 14px system-ui'; ctx.textAlign='center';
        ctx.fillText('ü™ô', bx+TILE/2, by+TILE/2-12);
      }

      // enemies
      for(var eI=0;eI<enemies.length;eI++){ var en=enemies[eI];
        drawActor(en.x,en.y, en.type==='ranged' ? '#a855f7' : getVar('--enemy'));
        drawHpBar(en.x,en.y,en.hp,en.maxHp,true, (target===en));
        if(target===en){ drawTargetRing(en.x,en.y); }
      }
      // player
      drawActor(player.x,player.y,getVar('--player'));
      drawHpBar(player.x,player.y,player.hp,player.maxHp,false,false);

      // projectiles
      for(var pp=0; pp<projectiles.length; pp++){ var pr=projectiles[pp]; var px2=pr.x*TILE+TILE/2, py2=pr.y*TILE+TILE/2; ctx.fillStyle='#f87171'; ctx.beginPath(); ctx.arc(px2,py2,6,0,Math.PI*2); ctx.fill(); }

      drawDmgTexts();
      drawXpBar();

      statusEl.textContent = 'build: '+BUILD+' | LV '+player.lvl+' | HP '+player.hp+'/'+player.maxHp+' | coins '+player.coins+' | pots '+player.pots+(target?' | target lock ON'+(autoChase?' (auto)':''):'');
      ctx.fillStyle='#ffffffcc'; ctx.font='bold 14px system-ui'; ctx.fillText('BUILD '+BUILD, 8, 24);
    }

    function drawActor(tx,ty,color){
      var x=tx*TILE, y=ty*TILE;
      ctx.fillStyle=getVar('--shadow'); ctx.beginPath(); ctx.ellipse(x+TILE/2,y+TILE-12,18,6,0,0,Math.PI*2); ctx.fill();
      ctx.fillStyle=color; ctx.fillRect(x+TILE/2-16,y+TILE/2-22,32,36);
    }
    function drawHpBar(tx,ty,hp,maxHp,isEnemy,isTarget){
      var x=tx*TILE, y=ty*TILE, w=40, h=6, px=x+TILE/2-w/2, py=y+TILE/2-32;
      var r=Math.max(0,Math.min(1,hp/maxHp));
      var col='#10b981'; if(isEnemy){ if(r<0.66) col='#f59e0b'; if(r<0.33) col='#ef4444'; }
      ctx.fillStyle=getVar('--hpBack'); ctx.fillRect(px,py,w,h);
      ctx.fillStyle=col; ctx.fillRect(px,py,w*r,h);
      ctx.strokeStyle=isTarget ? '#f87171' : '#0008';
      ctx.lineWidth=isTarget ? 2 : 1;
      ctx.strokeRect(px,py,w,h);
      ctx.lineWidth=1;
    }
    function drawTargetRing(tx,ty){
      var x=tx*TILE+TILE/2, y=ty*TILE+TILE/2;
      ctx.save(); ctx.strokeStyle='#ef4444'; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(x,y,28,0,Math.PI*2); ctx.stroke(); ctx.restore();
    }
    function drawXpBar(){
      var pad=6, h=10, x=pad, y=pad, w=cv.width-pad*2, need=(player.lvl<MAX_LVL?xpNeeded(player.lvl):1), ratio=(player.lvl<MAX_LVL?Math.max(0,Math.min(1,player.exp/need)):1);
      ctx.fillStyle='rgba(11,18,36,.66)'; ctx.fillRect(x,y,w,h);
      ctx.fillStyle='#7c3aed'; ctx.fillRect(x,y,w*ratio,h);
      ctx.strokeStyle='#1f2a44'; ctx.strokeRect(x,y,w,h);
      ctx.fillStyle='#e5e7eb'; ctx.font='12px system-ui'; ctx.textAlign='left'; ctx.textBaseline='top';
      ctx.fillText('LV '+player.lvl+(player.lvl<MAX_LVL?(' ‚Äî '+Math.floor(ratio*100)+'%'):' ‚Äî MAX'), x, y+h+2);
    }
    function flashScreen(color){ ctx.save(); ctx.globalAlpha=.20; ctx.fillStyle=color; ctx.fillRect(0,0,cv.width,cv.height); ctx.restore(); }
    function flashCircle(tx,ty,color,alpha,r){ var x=tx*TILE+TILE/2,y=ty*TILE+TILE/2; ctx.save(); ctx.globalAlpha=alpha; ctx.fillStyle=color; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); ctx.restore(); }

    // --- Cooldown ring
    function drawAtkCooldown(){
      var now=performance.now(), remain=Math.max(0,player.atkCd-(now-player.lastAtk)), ratio=1-(remain/player.atkCd);
      var c=atkCdCtx, cx=28, cy=28, r=25;
      c.clearRect(0,0,56,56);
      c.globalAlpha=0.15; c.fillStyle='#000'; c.beginPath(); c.arc(cx,cy,r,0,Math.PI*2); c.fill();
      c.globalAlpha=0.85; c.strokeStyle= remain>0 ? '#94a3b8' : '#22c55e'; c.lineWidth=4; c.beginPath();
      c.arc(cx,cy,r-2,-Math.PI/2, -Math.PI/2 + ratio*2*Math.PI); c.stroke();
    }

    // --- Mini-mappa (aggiunge sacchi)
    function drawMini(){
      if(miniWrap.classList.contains('hidden')) return;
      miniCtx.clearRect(0,0,mini.width,mini.height);
      var x,y;
      for(y=0;y<ROWS;y++) for(x=0;x<COLS;x++){
        miniCtx.fillStyle = (map[y][x]===1)?'#2b3b66':'#164e24';
        miniCtx.fillRect(x* (mini.width/COLS), y* (mini.height/ROWS), (mini.width/COLS), (mini.height/ROWS));
      }
      // sacchi
      for(var lb=0; lb<lootBags.length; lb++){
        var b=lootBags[lb];
        miniCtx.fillStyle='#f59e0b';
        miniCtx.fillRect(b.x*(mini.width/COLS)+1, b.y*(mini.height/ROWS)+1, 3,3);
      }
      // coins
      miniCtx.fillStyle='#facc15';
      for(var i=0;i<coins.length;i++){ var c=coins[i]; miniCtx.fillRect(c.x*(mini.width/COLS)+1, c.y*(mini.height/ROWS)+1, 2,2); }
      // potions
      miniCtx.fillStyle='#a78bfa';
      for(var p=0;p<potions.length;p++){ var po=potions[p]; miniCtx.fillRect(po.x*(mini.width/COLS)+1, po.y*(mini.height/ROWS)+1, 2,2); }
      // enemies
      for(var eI=0;eI<enemies.length;eI++){ var en=enemies[eI]; miniCtx.fillStyle=(en.type==='ranged')?'#a855f7':'#ef4444';
        miniCtx.fillRect(en.x*(mini.width/COLS)+1, en.y*(mini.height/ROWS)+1, 3,3); }
      // player
      miniCtx.fillStyle='#3b82f6'; miniCtx.fillRect(player.x*(mini.width/COLS)+1, player.y*(mini.height/ROWS)+1, 3,3);
      // frame
      miniCtx.strokeStyle='#1f2a44'; miniCtx.strokeRect(0.5,0.5, mini.width-1, mini.height-1);
    }

    // --- Hotbar counters
    function updateHotbarCounts(){ potCntEl.textContent = String(player.pots||0); }

    function toast(msg){ statusEl.textContent='['+BUILD+'] '+msg; }

  }catch(e){ panic('boot', e); }
})();
</script>
</body>
</html>
